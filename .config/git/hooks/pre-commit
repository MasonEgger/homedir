#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# dependencies = []
# ///
# ABOUTME: Global git pre-commit hook for AI-assisted development workflows.
# Warns if no AI session summary is being committed (for repos with .ai-sessions/).

"""Git pre-commit hook that warns when committing without an AI session summary."""

import subprocess
import sys
from pathlib import Path


def has_ai_sessions_dir() -> bool:
    """Check if current repo uses .ai-sessions/ directory."""
    return Path(".ai-sessions").is_dir()


def get_staged_ai_session_files() -> list[str]:
    """Get list of newly added files in .ai-sessions/ that are staged."""
    result = subprocess.run(
        ["git", "diff", "--cached", "--name-only", "--diff-filter=A"],
        capture_output=True,
        text=True,
        check=True,
    )
    return [f for f in result.stdout.strip().split("\n") if f.startswith(".ai-sessions/") and f]


def is_interactive() -> bool:
    """Check if we're running in an interactive terminal."""
    return sys.stdin.isatty()


def prompt_user() -> bool:
    """Prompt user for confirmation. Returns True if user wants to proceed."""
    try:
        # Read from /dev/tty for git hook context
        with open("/dev/tty", "r") as tty:
            print("\n⚠️  WARNING: No new AI session summary detected!\n")
            print("You are about to commit without a new file in .ai-sessions/")
            print("Session summaries help track AI-assisted development work.\n")
            print("Continue without AI session summary? [y/N] ", end="", flush=True)
            response = tty.readline().strip().lower()
            return response == "y"
    except (OSError, IOError):
        return False


def main() -> None:
    """Entry point for pre-commit hook."""
    # Skip check if repo doesn't use .ai-sessions/
    if not has_ai_sessions_dir():
        sys.exit(0)

    # Check for staged AI session files
    staged_files = get_staged_ai_session_files()
    if staged_files:
        # AI session file is being committed, all good
        sys.exit(0)

    # No AI session file staged - warn user
    if is_interactive():
        if prompt_user():
            print("Proceeding without AI session summary...")
            sys.exit(0)
        else:
            print("Commit aborted. Please add an AI session summary to .ai-sessions/")
            sys.exit(1)
    else:
        # Non-interactive mode (CI/CD) - fail by default
        print("\n⚠️  WARNING: No new AI session summary detected!")
        print("Non-interactive mode. Use --no-verify to skip this check.")
        sys.exit(1)


if __name__ == "__main__":
    main()
