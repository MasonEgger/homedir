---
# Package Management Tasks
- name: Update Homebrew (macOS)
  homebrew:
    update_homebrew: yes
  when: ansible_os_family == "Darwin"
  tags: packages

- name: Install packages via Homebrew (macOS)
  homebrew:
    name: "{{ brew_packages }}"
    state: present
  when: ansible_os_family == "Darwin"
  tags: packages

- name: Update apt cache (Ubuntu/Debian)
  apt:
    update_cache: yes
  become: yes
  when: ansible_os_family == "Debian"
  tags: packages

- name: Install packages via apt (Ubuntu/Debian)
  apt:
    name: "{{ apt_packages }}"
    state: present
  become: yes
  when: ansible_os_family == "Debian"
  tags: packages

# Install uv Python package manager (installs to ~/.local/bin which isn't in Ansible's PATH)
- name: Check if uv is installed
  stat:
    path: "{{ ansible_env.HOME }}/.local/bin/uv"
  register: uv_check
  tags: packages

- name: Install uv Python package manager
  shell: curl -LsSf https://astral.sh/uv/install.sh | sh
  when: not uv_check.stat.exists and not ansible_check_mode
  tags: packages

# Install kubectl on Linux (already available via brew on macOS as kubernetes-cli)
- name: Check if kubectl is installed
  command: which kubectl
  register: kubectl_check
  ignore_errors: yes
  changed_when: false
  tags: packages

- name: Install kubectl (Linux)
  shell: |
    cd /tmp
    curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    chmod +x kubectl
    sudo mv kubectl /usr/local/bin/
  become: yes
  when: kubectl_check.rc != 0 and ansible_os_family == "Debian" and not ansible_check_mode
  tags: packages

# Install just from GitHub releases on Linux (already available via brew on macOS)
- name: Check if just is installed
  command: which just
  register: just_check
  ignore_errors: yes
  changed_when: false
  tags: packages

- name: Install just from GitHub releases (Linux)
  shell: |
    cd /tmp
    curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
  become: yes
  when: just_check.rc != 0 and ansible_os_family == "Debian" and not ansible_check_mode
  tags: packages

# Install lychee from GitHub releases on Linux (already available via brew on macOS)
- name: Check if lychee is installed
  command: which lychee
  register: lychee_check
  ignore_errors: yes
  changed_when: false
  tags: packages

- name: Install lychee from GitHub releases (Linux)
  shell: |
    cd /tmp
    curl -s https://api.github.com/repos/lycheeverse/lychee/releases/latest | grep "browser_download_url.*lychee-x86_64-unknown-linux-gnu.tar.gz" | cut -d '"' -f 4 | xargs curl -L -o lychee.tar.gz
    tar -xzf lychee.tar.gz
    sudo mv lychee /usr/local/bin/
    rm lychee.tar.gz
  when: lychee_check.rc != 0 and ansible_os_family == "Debian" and not ansible_check_mode
  tags: packages