---
# Core Dotfiles Installation Tasks (hidden files at top level, excluding directories)
# Get target user home directory
- name: Get target user home directory
  set_fact:
    target_user_home: "{{ new_user_home if create_user else ansible_user_dir }}"
  tags: dotfiles

# Oh My Zsh installation (prerequisite for .zshrc)
- name: Check if Oh My Zsh is already installed
  stat:
    path: "{{ target_user_home }}/.oh-my-zsh"
  register: ohmyzsh_installed
  become: "{{ create_user }}"
  become_user: "{{ target_user if create_user else omit }}"
  tags: dotfiles

- name: Download Oh My Zsh installation script
  get_url:
    url: https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh
    dest: /tmp/install_ohmyzsh.sh
    mode: '0755'
  when: not ohmyzsh_installed.stat.exists
  tags: dotfiles

- name: Install Oh My Zsh
  command: /tmp/install_ohmyzsh.sh --unattended
  environment:
    RUNZSH: "no"
    CHSH: "no"
  become: "{{ create_user }}"
  become_user: "{{ target_user if create_user else omit }}"
  when: not ohmyzsh_installed.stat.exists and not ansible_check_mode
  tags: dotfiles

- name: Clean up Oh My Zsh installation script
  file:
    path: /tmp/install_ohmyzsh.sh
    state: absent
  when: not ohmyzsh_installed.stat.exists
  tags: dotfiles

- name: Install dotfiles (.vimrc, .zshrc, .tmux.conf, etc.) except .gitconfig
  copy:
    src: "{{ item }}"
    dest: "{{ target_user_home }}/{{ item | basename }}"
    backup: no
    mode: preserve
  with_fileglob:
    - "{{ dotfiles_dir }}/.*"
  when: item is file and (item | basename) not in ['.gitignore', '.gitconfig']
  become: "{{ create_user }}"
  become_user: "{{ target_user if create_user else omit }}"
  register: core_dotfiles_installed
  tags: dotfiles

- name: Detect GPG signing key
  shell: gpg --list-secret-keys --keyid-format=long 2>/dev/null | grep -E "^sec" | head -1 | sed 's/.*\/\([A-F0-9]*\) .*/\1/'
  register: gpg_key_result
  changed_when: false
  failed_when: false
  become: "{{ create_user }}"
  become_user: "{{ target_user if create_user else omit }}"
  tags: dotfiles

- name: Set GPG signing key fact
  set_fact:
    gpg_signing_key: "{{ gpg_key_result.stdout | default('') }}"
  tags: dotfiles

- name: Warn if no GPG key found
  debug:
    msg: "WARNING: No GPG signing key found. Git commit signing will be disabled. Run 'gpg --list-secret-keys' to check your keys."
  when: gpg_signing_key == ''
  tags: dotfiles

- name: Install .gitconfig from template
  template:
    src: "{{ playbook_dir }}/templates/gitconfig.j2"
    dest: "{{ target_user_home }}/.gitconfig"
    mode: '0644'
  become: "{{ create_user }}"
  become_user: "{{ target_user if create_user else omit }}"
  tags: dotfiles

- name: Create .zshrc.local if it doesn't exist
  copy:
    content: |
      # Machine-specific zsh configuration
      # This file is ignored by git and safe for local customization
      # See .zshrc.local.example in the repository for usage examples
    dest: "{{ target_user_home }}/.zshrc.local"
    mode: '0644'
    force: no
  become: "{{ create_user }}"
  become_user: "{{ target_user if create_user else omit }}"
  tags: dotfiles

# Include modular dotfile installations
- name: Include git hooks installation
  include_tasks: dotfiles/git-hooks.yml
  tags: dotfiles

- name: Include Vale configuration installation
  include_tasks: dotfiles/vale-config.yml
  tags: dotfiles