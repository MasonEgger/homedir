---
- name: Homedir Setup - Dotfiles and Package Management
  hosts: localhost
  gather_facts: yes
  become: false

  # Variables are now loaded automatically from group_vars/all.yml

  tasks:
    # User creation (Linux only, opt-in via create_user variable)
    - name: Include user creation tasks
      include_tasks: tasks/user.yml
      tags: user
      when: create_user

    # Include modular tasks
    - name: Include package management tasks
      include_tasks: tasks/packages.yml
      tags: packages

    - name: Include core dotfiles tasks
      include_tasks: tasks/dotfiles.yml
      tags: dotfiles

    - name: Include .claude directory tasks
      include_tasks: tasks/claude-config.yml
      tags: claude-config

    - name: Include .homedir directory tasks
      include_tasks: tasks/homedir.yml
      tags: homedir

    # Summary
    # Note: When no tags are specified, ansible_run_tags is empty but all tasks run
    - name: Installation summary
      vars:
        all_tags_ran: "{{ ansible_run_tags | length == 0 }}"
      debug:
        msg:
          - "=== Installation Summary ==="
          - "OS: {{ ansible_os_family }}"
          - "Mode: {{ 'New User Creation' if create_user else 'Existing User Setup' }}"
          - "Target User: {{ target_user }}"
          - "User created: {{ 'Yes' if (create_user and (all_tags_ran or 'user' in ansible_run_tags)) else 'N/A' }}"
          - "Packages installed: {{ 'Yes' if (all_tags_ran or 'packages' in ansible_run_tags) else 'Skipped' }}"
          - "Core dotfiles installed: {{ 'Yes' if (all_tags_ran or 'dotfiles' in ansible_run_tags) else 'Skipped' }}"
          - "Claude config installed: {{ 'Yes' if (all_tags_ran or 'claude-config' in ansible_run_tags) else 'Skipped' }}"
          - "Homedir directory installed: {{ 'Yes' if (all_tags_ran or 'homedir' in ansible_run_tags) else 'Skipped' }}"
          - ""
          - "{{ 'Setup complete! You may need to:' if not ansible_check_mode else 'This was a check mode run. To actually install, run without --check' }}"
          - "{{ '- Login as new user: su - ' + target_user if (create_user and not ansible_check_mode) else '' }}"
          - "{{ '- Change password on first login (required)' if (create_user and not ansible_check_mode) else '' }}"
          - "{{ '- Restart your shell or run: source ~/.zshrc' if not ansible_check_mode else '' }}"
          - "{{ '- Check that custom commands in ~/.homedir/ work as expected' if not ansible_check_mode else '' }}"
      tags: always